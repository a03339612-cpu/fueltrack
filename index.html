<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fuel Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { /* ... CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ... */ }
        body { /* ... —Å—Ç–∏–ª–∏ body ... */ }
        .card { /* ... —Å—Ç–∏–ª–∏ card ... */ }
        .input-group { margin-bottom: 1rem; }
        .input-group label { display: block; color: var(--tg-theme-hint-color); margin-bottom: 0.5rem; font-size: 0.875rem; }
        .input-field { width: 100%; padding: 0.75rem; border-radius: 0.5rem; border: 1px solid var(--tg-theme-bg-color); background-color: var(--tg-theme-bg-color); color: var(--tg-theme-text-color); font-size: 1rem; box-sizing: border-box; }
        .btn { padding: 0.875rem; border-radius: 0.5rem; border: none; font-weight: 600; cursor: pointer; transition: background-color 0.2s; width: 100%; }
        .btn-primary { background-color: var(--tg-theme-button-color); color: var(--tg-theme-button-text-color); }
        .btn-secondary { background-color: var(--tg-theme-secondary-bg-color); color: var(--tg-theme-button-color); border: 1px solid var(--tg-theme-button-color); }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: var(--tg-theme-bg-color); padding: 1.5rem; border-radius: 1rem; width: 90%; max-width: 400px; }
        .hidden { display: none; }
        .table-like { display: grid; grid-template-columns: 1fr repeat(3, auto); gap: 0.5rem 1rem; align-items: center; }
    </style>
</head>
<body>

    <div id="loader" class="text-center p-8"><p class="text-lg animate-pulse">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</p></div>

    <div id="main-screen" class="hidden">
        <div class="card">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h1 class="text-xl font-bold" id="current-car-name">–ú–æ–µ –∞–≤—Ç–æ</h1>
                    <p class="text-sm" id="current-car-plate"></p>
                </div>
                <div class="flex items-center space-x-2">
                    <button id="main-settings-btn" class="text-2xl">‚öôÔ∏è</button>
                    <button id="select-car-btn" class="text-sm text-blue-500">–°–º–µ–Ω–∏—Ç—å</button>
                </div>
            </div>
            <div>
                <p>–¢–µ–∫—É—â–∏–π –ø—Ä–æ–±–µ–≥: <strong id="current-mileage">0</strong> –∫–º</p>
                <p>–û—Å—Ç–∞—Ç–æ–∫ –≤ –±–∞–∫–µ: <strong id="current-fuel">0</strong> –ª</p>
            </div>
        </div>
        
        <div id="recent-logs-card" class="card hidden">
            <h2 class="text-lg font-bold mb-4">–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–∞—Å—á–µ—Ç—ã</h2>
            <div id="recent-logs-container" class="text-sm space-y-2"></div>
        </div>

        <div class="card">
            <h2 class="text-lg font-bold mb-4">–†–∞—Å—á–µ—Ç –ø–æ–µ–∑–¥–∫–∏</h2>
            <form id="trip-form">
                <!-- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –Ω–æ–≤–∞—è –∫–æ–º–ø–∞–∫—Ç–Ω–∞—è —Ä–∞–∑–º–µ—Ç–∫–∞ —Ñ–æ—Ä–º—ã -->
                <div class="grid grid-cols-2 gap-4">
                    <div class="input-group"><label for="end-mileage">–ö–æ–Ω–µ—á–Ω—ã–π –ø—Ä–æ–±–µ–≥</label><input type="number" id="end-mileage" class="input-field" required></div>
                    <div class="input-group"><label for="trip-date">–î–∞—Ç–∞</label><input type="date" id="trip-date" class="input-field" required></div>
                    <div class="input-group"><label for="refueled">–ó–∞–ø—Ä–∞–≤–ª–µ–Ω–æ (–ª)</label><input type="number" step="0.01" id="refueled" class="input-field" value="0"></div>
                    <div class="input-group"><label for="idle-hours">–ü—Ä–æ—Å—Ç–æ–π (—á–∞—Å—ã)</label><input type="number" step="0.1" id="idle-hours" class="input-field" value="0"></div>
                </div>
                <div class="flex gap-4 mt-4">
                    <button type="button" id="reset-btn" class="btn btn-secondary">–°–±—Ä–æ—Å</button>
                    <button type="submit" class="btn btn-primary">–†–∞—Å—Å—á–∏—Ç–∞—Ç—å</button>
                </div>
            </form>
        </div>
        
        <div class="card">
             <h2 class="text-lg font-bold mb-4">–û—Ç—á–µ—Ç</h2>
             <div class="grid grid-cols-2 gap-4">
                 <div class="input-group"><label for="report-start-date">–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞</label><input type="date" id="report-start-date" class="input-field"></div>
                 <div class="input-group"><label for="report-end-date">–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</label><input type="date" id="report-end-date" class="input-field"></div>
             </div>
            <button id="download-report-btn" class="btn btn-secondary mt-2">–°–∫–∞—á–∞—Ç—å –æ—Ç—á–µ—Ç (XLSX)</button>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
    <div id="settings-modal" class="modal-backdrop hidden"></div>
    <div id="cars-modal" class="modal-backdrop hidden"></div>
    <div id="alert-modal" class="modal-backdrop hidden"></div>
    <!-- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –ù–æ–≤–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div id="edit-car-modal" class="modal-backdrop hidden"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- –í—Å—Ç–∞–≤–∫–∞ HTML –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω ---
    document.getElementById('settings-modal').innerHTML = `...`; // –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    document.getElementById('cars-modal').innerHTML = `...`; // –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    document.getElementById('alert-modal').innerHTML = `...`; // –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    
    // –ò–ó–ú–ï–ù–ï–ù–ò–ï: HTML –¥–ª—è –Ω–æ–≤–æ–≥–æ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    document.getElementById('edit-car-modal').innerHTML = `
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–≤—Ç–æ</h2>
            <form id="edit-car-form">
                <input type="hidden" id="edit-car-id">
                <div class="input-group">
                    <label for="edit-car-name">–ú–∞—Ä–∫–∞ –∏ –º–æ–¥–µ–ª—å</label>
                    <input type="text" id="edit-car-name" class="input-field" required>
                </div>
                <div class="input-group">
                    <label for="edit-car-plate">–ì–æ—Å. –Ω–æ–º–µ—Ä</label>
                    <input type="text" id="edit-car-plate" class="input-field">
                </div>
                <div class="flex gap-4 mt-4">
                    <button type="button" id="close-edit-car-btn" class="btn btn-secondary">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>`;

    
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    const API_BASE_URL = '';
    const state = { /* ... –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */ };

    // --- –≠–ª–µ–º–µ–Ω—Ç—ã UI ---
    // ... (—Å—Ç–∞—Ä—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    const editCarModal = document.getElementById('edit-car-modal');
    const editCarForm = document.getElementById('edit-car-form');
    const editCarIdInput = document.getElementById('edit-car-id');
    const editCarNameInput = document.getElementById('edit-car-name');
    const editCarPlateInput = document.getElementById('edit-car-plate');
    
    // --- –§—É–Ω–∫—Ü–∏–∏ ---
    const customShowAlert = (message) => { /* ... –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */ };
    const apiRequest = async (endpoint, method = 'GET', body = null) => { /* ... –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */ };
    const renderRecentLogs = (logs) => { /* ... –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */ };
    const loadRecentLogs = async (carId) => { /* ... –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */ };

    const updateUI = () => {
        if (!state.activeCarId || state.cars.length === 0) { /* ... –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */ }
        const activeCar = state.cars.find(c => c.id === state.activeCarId);
        if (activeCar) { /* ... –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */ }
        
        carListContainer.innerHTML = '';
        state.cars.forEach(car => {
            const carDiv = document.createElement('div');
            carDiv.className = 'flex justify-between items-center p-3 rounded-lg ' + (car.id === state.activeCarId ? 'bg-blue-100' : 'bg-gray-100');
            
            // –ò–ó–ú–ï–ù–ï–ù–ò–ï: –î–æ–±–∞–≤–ª–µ–Ω—ã –∫–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏—è
            carDiv.innerHTML = `
                <div>
                    <p class="font-bold">${car.name}</p>
                    <p class="text-sm text-gray-500">${car.plate || ''}</p>
                </div>
                <div class="flex items-center space-x-3">
                    <button data-car-id="${car.id}" class="edit-btn text-xl">‚úèÔ∏è</button>
                    <button data-car-id="${car.id}" class="delete-btn text-xl">üóëÔ∏è</button>
                    ${car.id !== state.activeCarId ? `<button data-car-id="${car.id}" class="select-btn text-sm text-blue-500">–í—ã–±—Ä–∞—Ç—å</button>` : ''}
                </div>`;
            carListContainer.appendChild(carDiv);

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –Ω–æ–≤—ã—Ö –∫–Ω–æ–ø–æ–∫
            carDiv.querySelector('.edit-btn').addEventListener('click', (e) => {
                openEditCarModal(parseInt(e.currentTarget.dataset.carId, 10));
            });
            carDiv.querySelector('.delete-btn').addEventListener('click', (e) => {
                handleDeleteCar(parseInt(e.currentTarget.dataset.carId, 10));
            });

            const selectBtn = carDiv.querySelector('.select-btn');
            if (selectBtn) { /* ... –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ selectBtn –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */ }
        });
        
        mainScreen.classList.remove('hidden'); loader.classList.add('hidden');
    };
    
    const showModal = (modalName) => {
        if (modalName === 'settings') settingsModal.classList.remove('hidden');
        if (modalName === 'cars') carsModal.classList.remove('hidden');
        if (modalName === 'editCar') editCarModal.classList.remove('hidden');
    };
    const hideModals = () => {
        settingsModal.classList.add('hidden'); carsModal.classList.add('hidden');
        editCarModal.classList.add('hidden');
    };

    const loadInitialData = async () => { /* ... –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */ };
    const handleTripCalculation = async (e) => { /* ... –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */ };
    const handleAddCar = async (e) => { /* ... –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */ };
    const handleReportDownload = async () => { /* ... –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π ... */ };

    // --- –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è ---
    const openEditCarModal = (carId) => {
        const car = state.cars.find(c => c.id === carId);
        if(car) {
            editCarIdInput.value = car.id;
            editCarNameInput.value = car.name;
            editCarPlateInput.value = car.plate || '';
            showModal('editCar');
        }
    };
    
    const handleEditCarSave = async (e) => {
        e.preventDefault();
        const carId = parseInt(editCarIdInput.value, 10);
        const payload = {
            name: editCarNameInput.value,
            plate: editCarPlateInput.value
        };
        try {
            await apiRequest(`/cars/details/${carId}`, 'PUT', payload);
            const carIndex = state.cars.findIndex(c => c.id === carId);
            state.cars[carIndex].name = payload.name;
            state.cars[carIndex].plate = payload.plate;
            updateUI();
            hideModals();
            customShowAlert('–î–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω—ã.');
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∞–≤—Ç–æ', error);
        }
    };

    const handleDeleteCar = async (carId) => {
        const car = state.cars.find(c => c.id === carId);
        if (!car) return;

        tg.showConfirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—å "${car.name}" –∏ –≤—Å—é –µ–≥–æ –∏—Å—Ç–æ—Ä–∏—é? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.`, async (confirmed) => {
            if (confirmed) {
                try {
                    await apiRequest(`/cars/${carId}/${state.userId}`, 'DELETE');
                    customShowAlert(`–ê–≤—Ç–æ–º–æ–±–∏–ª—å "${car.name}" —É–¥–∞–ª–µ–Ω.`);
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ, —á—Ç–æ–±—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –∞–∫—Ç–∏–≤–Ω–æ–µ –∞–≤—Ç–æ
                    await loadInitialData();
                    hideModals();
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', error);
                }
            }
        });
    };
    
    const handleSettingsSave = async (e) => { // –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω URL
        e.preventDefault();
        const carId = parseInt(settingsCarIdInput.value, 10);
        const payload = { /* ... */ };
        try {
            const updatedCar = await apiRequest(`/cars/settings/${carId}`, 'PUT', payload);
            // ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
        } catch (error) { console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫', error); }
    };

    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏ —Å–ª—É—à–∞—Ç–µ–ª–∏ —Å–æ–±—ã—Ç–∏–π ---
    // ... (—Å—Ç–∞—Ä—ã–µ —Å–ª—É—à–∞—Ç–µ–ª–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    editCarForm.addEventListener('submit', handleEditCarSave);
    document.getElementById('close-edit-car-btn').addEventListener('click', hideModals);
    // ... (–æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–ª—É—à–∞—Ç–µ–ª–∏ –∏ –≤—ã–∑–æ–≤—ã –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)

    loadInitialData();
});
</script>
</body>
</html>

