<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fuel Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { /* ... CSS ... */ }
        body { /* ... CSS ... */ }
        .card { /* ... CSS ... */ }
        .input-group { /* ... CSS ... */ }
        .input-field { /* ... CSS ... */ }
        .btn { /* ... CSS ... */ }
        .modal-backdrop { /* ... CSS ... */ }
        .table-like { /* ... CSS ... */ }
    </style>
</head>
<body>

    <div id="loader" class="text-center p-8"><p class="text-lg animate-pulse">Загрузка данных...</p></div>

    <div id="main-screen" class="hidden">
        <!-- ... HTML ... -->
    </div>

    <!-- Модальные окна -->
    <div id="settings-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">Настройки авто</h2>
            <form id="settings-form">
                <input type="hidden" id="settings-car-id">
                <div class="input-group"><label>Начальный пробег (км)</label><input type="number" id="settings-start-mileage" class="input-field" required></div>
                <div class="input-group"><label>Начальный остаток (л)</label><input type="number" step="0.01" id="settings-initial-fuel" class="input-field" required></div>
                <div class="input-group"><label>Расход в движении (л/100 км)</label><input type="number" step="0.01" id="settings-consumption-driving" class="input-field" required></div>
                <div class="input-group"><label>Расход на простое (л/час)</label><input type="number" step="0.01" id="settings-consumption-idle" class="input-field" required></div>
                <div class="flex gap-4 mt-4">
                    <button type="button" id="close-settings-btn" class="btn btn-secondary">Отмена</button>
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="cars-modal" class="modal-backdrop hidden">
        <!-- ... HTML ... -->
    </div>
    
    <div id="alert-modal" class="modal-backdrop hidden">
        <!-- ... HTML ... -->
    </div>

    <div id="edit-car-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">Редактировать авто</h2>
            <form id="edit-car-form">
                <input type="hidden" id="edit-car-id">
                <div class="input-group"><label for="edit-car-name">Марка и модель</label><input type="text" id="edit-car-name" class="input-field" required></div>
                <div class="input-group"><label for="edit-car-plate">Гос. номер</label><input type="text" id="edit-car-plate" class="input-field"></div>
                <div class="flex gap-4 mt-4">
                    <button type="button" id="close-edit-car-btn" class="btn btn-secondary">Отмена</button>
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                </div>
            </form>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    try {
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        const state = {
            userId: String(tg.initDataUnsafe?.user?.id || 'test_user_123'),
            cars: [],
            activeCarId: null,
        };
        const DOMElements = { /* ... */ };

        const showModal = (modalName) => { /* ... */ };
        const hideModals = () => { /* ... */ };
        const customShowAlert = (message) => { /* ... */ };
        const apiRequest = async (endpoint, method = 'GET', body = null) => { /* ... */ };
        const renderRecentLogs = (logs) => { /* ... */ };

        const loadRecentLogs = async (carId) => {
            try {
                if (carId) {
                    const logs = await apiRequest(`/logs/${carId}/${state.userId}`);
                    renderRecentLogs(logs);
                } else {
                     DOMElements.recentLogsCard.classList.add('hidden');
                }
            } catch(e) { console.error("Failed to load logs", e); }
        };

        const updateUI = () => { /* ... */ };
        const openEditCarModal = (carId) => { /* ... */ };
        const handleDeleteCar = async (carId) => { /* ... */ };
        const openSettingsForCar = (carId) => { /* ... */ };
        const initApp = async (isReload = false) => { /* ... */ };
        
        // --- ОБРАБОТЧИКИ СОБЫТИЙ ---
        
        DOMElements.settingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const carId = parseInt(DOMElements.settingsCarId.value);
            const payload = {
                user_id: state.userId,
                current_mileage: parseFloat(DOMElements.settingsStartMileage.value),
                current_fuel: parseFloat(DOMElements.settingsInitialFuel.value),
                consumption_driving: parseFloat(DOMElements.settingsConsumptionDriving.value),
                consumption_idle: parseFloat(DOMElements.settingsConsumptionIdle.value)
            };
            try {
                const updatedCarData = await apiRequest(`/cars/settings/${carId}`, 'PUT', payload);
                const carIndex = state.cars.findIndex(c => c.id === carId);
                if (carIndex !== -1) {
                    Object.assign(state.cars[carIndex], updatedCarData);
                }
                updateUI(); hideModals(); customShowAlert('Настройки сохранены.');
            } catch (error) { console.error('Ошибка сохранения настроек', error); }
        });

        DOMElements.editCarForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const carId = parseInt(DOMElements.editCarId.value);
            const payload = { 
                user_id: state.userId,
                name: DOMElements.editCarName.value, 
                plate: DOMElements.editCarPlate.value 
            };
            try {
                await apiRequest(`/cars/details/${carId}`, 'PUT', payload);
                const carIndex = state.cars.findIndex(c => c.id === carId);
                state.cars[carIndex].name = payload.name; 
                state.cars[carIndex].plate = payload.plate;
                updateUI(); hideModals(); customShowAlert('Данные автомобиля обновлены.');
            } catch (error) { console.error('Ошибка при редактировании авто', error); }
        });
        
        document.getElementById('download-report-btn').addEventListener('click', async () => {
            const startDate = DOMElements.reportStartDate.value;
            const endDate = DOMElements.reportEndDate.value;
            if (!startDate || !endDate) return customShowAlert('Выберите начальную и конечную дату для отчета.');
            if (!state.activeCarId) return customShowAlert('Выберите автомобиль.');
            try {
                const response = await apiRequest(`/report?car_id=${state.activeCarId}&user_id=${state.userId}&start_date=${startDate}&end_date=${endDate}`);
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                const car = state.cars.find(c => c.id === state.activeCarId);
                a.download = `report_${car.name.replace(/\s+/g, '_')}_${startDate}_${endDate}.xlsx`;
                document.body.appendChild(a); a.click();
                window.URL.revokeObjectURL(url); document.body.removeChild(a);
            } catch (error) { console.error('Ошибка скачивания отчета', error); }
        });

        // ... (остальные обработчики)
        
        // Запуск
        initApp();

    } catch (e) { /* ... */ }
});
</script>

</body>
</html>

