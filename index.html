<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fuel Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { /* ... */ }
        body { /* ... */ }
        .card { /* ... */ }
        .input-group { /* ... */ }
        .input-field { /* ... */ }
        .btn { /* ... */ }
        .modal-backdrop { /* ... */ }
        .table-like { 
            display: grid;
            /* ИЗМЕНЕНИЕ: Добавляем колонку для кнопки */
            grid-template-columns: 1fr repeat(3, auto) 30px; 
            gap: 0.5rem 1rem; 
            align-items: center; 
        }
    </style>
</head>
<body>

    <div id="loader" class="text-center p-8"><p class="text-lg animate-pulse">Загрузка данных...</p></div>

    <div id="main-screen" class="hidden">
        <!-- ... -->
        <div class="card">
            <h2 class="text-lg font-bold mb-4">Расчет поездки</h2>
            <form id="trip-form">
                <div class="grid grid-cols-2 gap-4">
                    <div class="input-group"><label>Конечный пробег</label><input type="number" id="end-mileage" class="input-field" required></div>
                    <div class="input-group"><label>Дата</label><input type="date" id="trip-date" class="input-field" required></div>
                    <!-- ИЗМЕНЕНИЕ: Убираем value="0", добавляем placeholder -->
                    <div class="input-group"><label>Заправлено (л)</label><input type="number" step="0.01" id="refueled" class="input-field" placeholder="0"></div>
                    <div class="input-group"><label>Простой (часы)</label><input type="number" step="0.1" id="idle-hours" class="input-field" placeholder="0"></div>
                </div>
                <!-- ... -->
            </form>
        </div>
        <!-- ... -->
    </div>

    <!-- Модальные окна -->
    <div id="settings-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <!-- ... -->
            <form id="settings-form">
                <!-- ... -->
                <div class="input-group"><label>Расход на простое (л/час)</label><input type="number" step="0.01" id="settings-consumption-idle" class="input-field" required></div>
                <!-- ... -->
            </form>
        </div>
    </div>
    <!-- ... (остальные модальные окна без изменений) ... -->

    <!-- ИЗМЕНЕНИЕ: Новое модальное окно для редактирования лога -->
    <div id="edit-log-modal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">Редактировать запись</h2>
            <form id="edit-log-form">
                <input type="hidden" id="edit-log-id">
                <div class="input-group"><label for="edit-log-date">Дата</label><input type="date" id="edit-log-date" class="input-field" required></div>
                <div class="input-group"><label for="edit-log-end-mileage">Конечный пробег (км)</label><input type="number" id="edit-log-end-mileage" class="input-field" required></div>
                <div class="input-group"><label for="edit-log-refueled">Заправлено (л)</label><input type="number" step="0.01" id="edit-log-refueled" class="input-field"></div>
                <div class="input-group"><label for="edit-log-idle-hours">Простой (часы)</label><input type="number" step="0.1" id="edit-log-idle-hours" class="input-field"></div>
                <div class="flex gap-4 mt-4">
                    <button type="button" id="close-edit-log-btn" class="btn btn-secondary">Отмена</button>
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                </div>
            </form>
        </div>
    </div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    try {
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();

        const state = { /* ... */ };
        const DOMElements = {
            // ... (все старые элементы)
            editLogModal: document.getElementById('edit-log-modal'),
            editLogForm: document.getElementById('edit-log-form'),
            editLogId: document.getElementById('edit-log-id'),
            editLogDate: document.getElementById('edit-log-date'),
            editLogEndMileage: document.getElementById('edit-log-end-mileage'),
            editLogRefueled: document.getElementById('edit-log-refueled'),
            editLogIdleHours: document.getElementById('edit-log-idle-hours'),
        };

        const showModal = (modalName) => {
            // ...
            if (modalName === 'editLog') DOMElements.editLogModal.classList.remove('hidden');
        };
        const hideModals = () => {
            // ...
            DOMElements.editLogModal.classList.add('hidden');
        };
        
        const apiRequest = async (endpoint, method = 'GET', body = null) => { /* ... */ };
        
        const renderRecentLogs = (logs) => {
            if (!logs || logs.length === 0) {
                DOMElements.recentLogsCard.classList.add('hidden');
                return;
            }
            DOMElements.recentLogsContainer.innerHTML = '';
            const header = document.createElement('div');
            header.className = 'table-like pb-2 mb-2 border-b border-gray-300';
            // ИЗМЕНЕНИЕ: Добавляем пустой заголовок для колонки с кнопкой
            header.innerHTML = `<div class="font-semibold text-gray-500 text-xs col-span-1">ДАТА</div>
                                <div class="font-semibold text-gray-500 text-xs text-right">ПРОБЕГ</div>
                                <div class="font-semibold text-gray-500 text-xs text-right">РАСХОД</div>
                                <div class="font-semibold text-gray-500 text-xs text-right">ОСТАТОК</div>
                                <div></div>`;
            DOMElements.recentLogsContainer.appendChild(header);

            logs.forEach(log => {
                const logDiv = document.createElement('div');
                logDiv.className = 'table-like pt-2';
                const tripDist = log.trip_distance > 0 ? `+${log.trip_distance.toFixed(0)}` : '0';
                // ИЗМЕНЕНИЕ: Добавляем кнопку редактирования с data-log-id
                logDiv.innerHTML = `
                    <div>${new Date(log.date).toLocaleDateString('ru-RU')}</div>
                    <div class="text-right">${tripDist} км</div>
                    <div class="text-right text-red-500">-${log.fuel_consumed_total.toFixed(2)} л</div>
                    <div class="text-right font-semibold">${log.final_fuel_level.toFixed(2)} л</div>
                    <button class="edit-log-btn text-xl" data-log-id="${log.id}">✏️</button>
                    ${log.refueled > 0 ? `<div class="col-span-5 text-right text-green-600 text-xs pt-1">+${log.refueled.toFixed(2)} л заправка</div>` : ''}
                `;
                DOMElements.recentLogsContainer.appendChild(logDiv);
                // Навешиваем обработчик на новую кнопку
                logDiv.querySelector('.edit-log-btn').addEventListener('click', (e) => {
                    openEditLogModal(parseInt(e.currentTarget.dataset.logId));
                });
            });
            DOMElements.recentLogsCard.classList.remove('hidden');
        };

        const loadRecentLogs = async (carId) => { /* ... */ };
        const updateUI = () => { /* ... */ };
        const openEditCarModal = (carId) => { /* ... */ };
        const handleDeleteCar = async (carId) => { /* ... */ };
        const openSettingsForCar = (carId) => { /* ... */ };
        const initApp = async (isReload = false) => { /* ... */ };

        // --- НОВЫЕ ФУНКЦИИ ---
        const openEditLogModal = async (logId) => {
            try {
                const logData = await apiRequest(`/logs/entry/${logId}/${state.userId}`);
                DOMElements.editLogId.value = logId;
                DOMElements.editLogDate.value = logData.date;
                DOMElements.editLogEndMileage.value = logData.end_mileage;
                DOMElements.editLogRefueled.value = logData.refueled;
                DOMElements.editLogIdleHours.value = logData.idle_hours;
                showModal('editLog');
            } catch (error) {
                console.error("Failed to fetch log entry for editing", error);
            }
        };

        // --- ОБРАБОТЧИКИ СОБЫТИЙ ---
        
        DOMElements.tripForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const activeCar = state.cars.find(c => c.id === state.activeCarId);
            if (!activeCar) return customShowAlert('Сначала выберите автомобиль.');
            // ИЗМЕНЕНИЕ: Парсим числа, обрабатывая пустую строку как 0
            const payload = {
                // ...
                refueled: parseFloat(DOMElements.refueledInput.value) || 0,
                idle_hours: parseFloat(DOMElements.idleHoursInput.value) || 0,
                // ...
            };
            // ... (остальная логика без изменений)
        });
        
        // ИЗМЕНЕНИЕ: Новый обработчик для формы редактирования лога
        DOMElements.editLogForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const logId = parseInt(DOMElements.editLogId.value);
            const payload = {
                user_id: state.userId,
                date: DOMElements.editLogDate.value,
                end_mileage: parseFloat(DOMElements.editLogEndMileage.value),
                refueled: parseFloat(DOMElements.editLogRefueled.value) || 0,
                idle_hours: parseFloat(DOMElements.editLogIdleHours.value) || 0,
            };

            tg.showConfirm('Пересчитать эту и все последующие записи?', async (confirmed) => {
                if (confirmed) {
                    try {
                        await apiRequest(`/logs/entry/${logId}`, 'PUT', payload);
                        customShowAlert('Данные успешно пересчитаны.');
                        hideModals();
                        initApp(true); // Полностью перезагружаем данные, чтобы увидеть все изменения
                    } catch (error) {
                         console.error('Ошибка при обновлении записи', error);
                    }
                }
            });
        });

        // ... (остальные обработчики)
        document.getElementById('close-edit-log-btn').addEventListener('click', hideModals);
        
        // Запуск
        initApp();

    } catch (e) { /* ... */ }
});
</script>

</body>
</html>

